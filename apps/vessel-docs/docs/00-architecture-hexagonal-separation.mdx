---
sidebar_position: 0
---

# Arquitectura Hexagonal - SeparaciÃ³n Domain/Infra

## ğŸ“Š AnÃ¡lisis de Dependencias

### âœ… Correcto: Infrastructure â†’ Domain
```
Infrastructure
    â†“
Domain (Interfaces)
    â†“
Domain (Entidades)

âœ… Infrastructure DEPENDE de Domain (es lo correcto)
âŒ Domain NO depende de Infrastructure (estÃ¡ protegido)
```

### VerificaciÃ³n Real - Stock Module

**Domain (Puro):**
```php
// app/Stock/Domain/Interfaces/CatalogGatewayInterface.php
interface CatalogGatewayInterface {
    public function linkToCatalog(StockItem $stockItem): void;
    public function attachCatalogData(iterable $stockItems): array;
}

// app/Stock/Domain/Entities/Movement.php
class Movement {
    public function __construct(
        private string $id,
        private MovementType $type,        // Domain ValueObject
        private string $itemId,
        private float $quantity,
        private MovementStatus $status = MovementStatus::PENDING,
        // ... solo tipos de dominio
    ) { }
}
```

**No hay**: `use Infrastructure\*` o `use Models\*`

---

**Infrastructure (Adaptador):**
```php
// app/Stock/Infrastructure/Out/Models/Eloquent/StockItemRepository.php
class StockItemRepository implements StockItemRepositoryInterface {
    use App\Stock\Domain\Entities\StockItem;
    use App\Stock\Domain\Interfaces\StockItemRepositoryInterface;
    //                        â†‘ Importa desde Domain âœ…
    
    public function findById(string $id): ?StockItem {
        $model = StockItemModel::find($id);
        return $model ? $this->toDomain($model) : null;
                         //    â†‘ Convierte Eloquent â†’ Domain
    }
    
    private function toDomain(StockItemModel $model): StockItem {
        return new StockItem(
            id: $model->id,
            sku: $model->sku,
            locationId: $model->location_id,
            quantity: (float) $model->quantity,
            // ... mapeo desde DB a entidad de dominio
        );
    }
}
```

---

## ğŸ¯ Patrones de SeparaciÃ³n Observados

### 1. **Repository Pattern - Mapeo Perfecto**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         APPLICATION LAYER               â”‚
â”‚  (UseCases, Services, Controllers)      â”‚
â”‚  âœ“ Usa Domain Entities                  â”‚
â”‚  âœ“ Usa Domain Interfaces                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ (pide a travÃ©s de interface)
                   â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  DOMAIN LAYER        â”‚
        â”‚  Interface           â”‚
        â”‚ (repositoryInterface)â”‚
        â”‚ âœ“ Puro, sin detalles â”‚
        â”‚ âœ“ agnÃ³stico a BD     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–²
                   â”‚ (implementa)
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    INFRASTRUCTURE LAYER                 â”‚
â”‚  EloquentStockItemRepository             â”‚
â”‚                                          â”‚
â”‚  - Usa Eloquent Models                  â”‚
â”‚  - Mapea DB â†” Domain Entities          â”‚
â”‚  - Implementa Domain Interfaces          â”‚
â”‚                                          â”‚
â”‚  âœ“ Conoce detalles de BD                â”‚
â”‚  âœ“ No contamina Domain                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. **Gateway Pattern - ComunicaciÃ³n Inter-mÃ³dulos**

```
Stock Domain              Catalog Domain
     â†‘                         â†‘
     â”‚ (usa Interface)         â”‚
     â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚ CatalogGatewayInterface â”‚    â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
     â”‚ (implementa)            â”‚
     â”‚                         â”‚
Stock Infrastructure          â”‚
     â”‚                         â”‚
â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”
â”‚  PortalCatalogGateway             â”‚
â”‚  - Llamadas a Portal              â”‚
â”‚  - Vincula Stock â†” Catalog        â”‚
â”‚  - NO accede directo a Catalog DB â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. **Adapter Middleware - Intercambiabilidad**

```
HTTP Request
     â”‚
     â–¼
AdapterMiddleware (determina adapter)
     â”‚
     â”œâ”€ "X-STOCK-ADAPTER: local"  â”€â”€â†’ InMemoryRepository
     â”‚
     â””â”€ (default) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ EloquentRepository
                                       â”‚
                                       â–¼
                                    Domain Layer
                                    (sin cambios)
```

**Importancia:** Domain NO sabe cuÃ¡l repositorio estÃ¡ usando.

---

## ğŸ“ˆ Complejidad vs Claridad

### **Score: 7/10 - Bien, pero tiene densidad**

| Aspecto | EvaluaciÃ³n | Notas |
|---------|-----------|-------|
| **SeparaciÃ³n Domain/Infra** | âœ… Excelente | Domain completamente limpio |
| **Curva de aprendizaje** | âš ï¸ Media | Muchas capas, pero ordenadas |
| **Entendibilidad rÃ¡pida** | âš ï¸ Media | Necesita tiempo para mapear flujo |
| **Facilidad de cambios** | âœ… Buena | Cambios en Infra no afectan Domain |
| **Testing** | âœ… Excelente | Mocks fÃ¡ciles por interfaces |

---

## ğŸ“š Flujo de Entendimiento (Recomendado)

### Paso 1: Entender Domain
```
1. Leer: Domain/Interfaces/StockItemRepositoryInterface.php
   â†’ "Â¿QuÃ© operaciones necesita Stock?"
   
2. Leer: Domain/Entities/StockItem.php
   â†’ "Â¿QuÃ© datos maneja Stock?"
   
3. Leer: Domain/Services/StockCapacityService.php
   â†’ "Â¿QuÃ© lÃ³gica de negocio hay?"
```

**Resultado:** Entiendes la lÃ³gica sin tocar DB.

### Paso 2: Entender Infrastructure
```
4. Leer: Infrastructure/Out/Models/Eloquent/StockItemRepository.php
   â†’ "Â¿CÃ³mo persiste en BD?"
   
5. Leer: Infrastructure/In/Http/Controllers/StockController.php
   â†’ "Â¿CÃ³mo recibe requests?"
```

**Resultado:** Entiendes cÃ³mo funciona realmente.

### Paso 3: Conectar
```
6. Leer: Infrastructure/StockServiceProvider.php
   â†’ "$app->bind(Interface, Implementation)"
   
7. Entiendes: Domain Interface se realiza en Infrastructure
```

---

## âš™ï¸ Complejidad: Desglose

### **NO ES complejo porque:**
âœ… Domain es simple (entidades + servicios)
âœ… Infrastructure es repetitivo pero predecible
âœ… SeparaciÃ³n es clara: In/Out y Models/Gateways
âœ… Bindings DI centralizados en ServiceProvider

### **SÃ TIENE densidad porque:**
âš ï¸ Muchas carpetas y niveles (5-6 niveles)
âš ï¸ Muchas interfaces vs implementaciones
âš ï¸ Necesita entender: Domain â†’ Interface â†’ Impl â†’ Routes
âš ï¸ Mapeos Eloquent â†” Domain requieren lectura

---

## ğŸ“ Ejemplo PrÃ¡ctico: Crear un Item de Stock

### Entender el flujo:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. HTTP REQUEST                                     â”‚
â”‚    POST /api/v1/stock/items/create                  â”‚
â”‚    Body: { sku: "PROD-001", quantity: 100 }        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. CONTROLLER (Infrastructure/In)                   â”‚
â”‚    app/Stock/Infrastructure/In/Http/Controller      â”‚
â”‚    â†’ Valida request                                 â”‚
â”‚    â†’ Llama UseCase                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. USECASE (Application Layer)                      â”‚
â”‚    app/Stock/Application/UseCases/CreateStockItem  â”‚
â”‚    â†’ LÃ³gica de aplicaciÃ³n                           â”‚
â”‚    â†’ Llama repositorio por INTERFAZ (Domain)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DOMAIN INTERFACE                                 â”‚
â”‚    app/Stock/Domain/Interfaces/                     â”‚
â”‚    StockItemRepositoryInterface::save()             â”‚
â”‚    (es solo firma, sin implementaciÃ³n)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ (se resuelve en runtime)
                     â”‚ (DI container busca implementaciÃ³n)
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. INFRASTRUCTURE IMPLEMENTATION                    â”‚
â”‚    app/Stock/Infrastructure/Out/Models/Eloquent/   â”‚
â”‚    StockItemRepository::save()                      â”‚
â”‚    â†’ Crea StockItemModel                            â”‚
â”‚    â†’ Guarda en BD                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. DATABASE                                         â”‚
â”‚    INSERT INTO stock_items (...)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Puntos clave:**
- Domain no ve la BD
- Infrastructure no contamina Domain
- Cambiar Eloquent â†’ Doctrine solo toca Step 5

---

## ğŸ” Revisar Acoplamiento

### Stock + Locations (LocationGateway)

**ACTUAL - Algo acoplado:**
```php
// app/Stock/Infrastructure/Out/Gateways/LocationsModuleGateway.php
class LocationsModuleGateway implements LocationGatewayInterface {
    public function __construct(
        private LocationRepository $locationRepository  // â† Repositorio directo
    ) { }
    
    public function getChildren(string $locationId) {
        return $this->locationRepository->findByFilters([
            'parent_id' => $locationId
        ]);
    }
}
```

**Problema:** Si Locations es microservicio remoto, esto no funciona.

**MEJOR - Usar Portal uniformemente:**
```php
class PortalLocationGateway implements LocationGatewayInterface {
    public function __construct(
        private Portal $portal
    ) { }
    
    public function getChildren(string $locationId) {
        return $this->portal->query('locations', [
            'parent_id' => $locationId
        ])->get();
    }
}
```

**Beneficio:** Funciona con BD local, Portal, HTTP, etc.

---

## ğŸ“‹ Resumen: Â¿FÃ¡cil o Complejo?

### Para **entender** la arquitectura:
**7-8/10 en facilidad** - PatrÃ³n claro, bien ejecutado, pero requiere tiempo.

### Para **modificar** cÃ³digo:
**8-9/10 en facilidad** - Cambios locales, impacto bajo, tests fÃ¡ciles.

### Para **agregar** nuevas caracterÃ­sticas:
**7/10 en facilidad** - Copiar patrÃ³n de otro mÃ³dulo, ajustar.

### Para **debuggear**:
**6/10 en facilidad** - Muchos niveles, requiere entender el flujo completo.

---

## âœ… ConclusiÃ³n

**Domain/Infrastructure estÃ¡ BIEN SEPARADO:**

```
âœ… Domain = Puro (sin dependencias de Infra)
âœ… Infrastructure = Implementa (depende de Domain)
âœ… No hay ciclos de dependencia
âœ… Testeable sin mockar BD
âœ… Intercambiable (InMemory vs Eloquent)
```

**Mejora sugerida:** Generalizar LocationGateway a usar Portal como CatalogGateway.
