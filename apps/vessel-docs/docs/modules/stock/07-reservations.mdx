---
sidebar_position: 7
---

# Reservations (Reservas de Stock)

Sistema completo de reservas con **tracking ligero** para identificar quiÃ©n reserva, para quÃ© y cuÃ¡ndo expira.

## ğŸ¯ Problema que Resuelve

Cuando tienes Ã³rdenes de venta, proyectos o prÃ©stamos que **necesitan garantizar stock** sin aÃºn enviarlo fÃ­sicamente:

- âŒ **Sin reservas**: Dos Ã³rdenes pueden vender el mismo stock
- âœ… **Con reservas**: Stock bloqueado hasta que se envÃ­e o cancele
- âœ… **Con tracking**: Sabes quiÃ©n reservÃ³, para quÃ© y cuÃ¡ndo expira ğŸ†•

---

## ğŸ“Š Modelo de Datos

### Stock Item (con reservas)

```json
{
  "id": "stock-abc-123",
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 100,           // Total fÃ­sico
  "reserved_quantity": 30,   // Bloqueado (reservas activas)
  "available_quantity": 70   // Libre para reservar/enviar
}
```

**FÃ³rmula**: `available_quantity = quantity - reserved_quantity`

---

### Reservation (entidad de tracking) ğŸ†•

```json
{
  "id": "res-abc-123",
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 10,
  "reserved_by": "user-123",           // QuiÃ©n reserva
  "reference_type": "sales_order",     // Para quÃ©
  "reference_id": "SO-2024-001",       // ID externo
  "status": "active",                  // active | released | expired
  "expires_at": "2024-12-31T23:59:59Z", // Opcional
  "created_at": "2024-12-01T10:00:00Z",
  "released_at": null
}
```

**Estados**:
- `active`: Reserva activa, bloqueando stock
- `released`: Liberada manualmente (orden cancelada)
- `expired`: ExpirÃ³ automÃ¡ticamente (por `expires_at`)

---

## ğŸ”„ API Endpoints

### 1. Validar Reserva (sin modificar estado)

```http
POST /api/v1/stock/reservations/validate

{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 10
}
```

**Response** (200 OK):
```json
{
  "can_reserve": true,
  "available_quantity": 70,
  "reserved_quantity": 30,
  "total_quantity": 100,
  "max_reservation_allowed": 80,
  "errors": [],
  "warnings": [],
  "item_info": {
    "name": "Producto X",
    "sku": "SKU-001",
    "category": "Electronics"
  },
  "location_info": {
    "name": "AlmacÃ©n Principal",
    "allow_negative_stock": false
  }
}
```

**Response** (422 Error):
```json
{
  "can_reserve": false,
  "errors": [
    "Stock disponible insuficiente. Disponible: 5, solicitado: 10"
  ]
}
```

---

### 2. Crear Reserva ğŸ†•

```http
POST /api/v1/stock/reservations/reserve

{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 10,
  "reserved_by": "user-123",              // ğŸ†• QuiÃ©n reserva
  "reference_type": "sales_order",        // Para quÃ©
  "reference_id": "SO-2024-001",          // ID externo
  "expires_at": "2024-12-31T23:59:59Z",   // ğŸ†• Opcional
  "reason": "Orden de venta #001",
  "skip_validation": false
}
```

**Response** (201 Created):
```json
{
  "success": true,
  "reservation_id": "res-abc-123",        // ğŸ†• ID del tracking
  "new_reserved_quantity": 40,
  "new_available_quantity": 60,
  "errors": [],
  "movement": {
    "id": "mov-xyz-456",
    "type": "reserve",
    "quantity": 10,
    "created_at": "2024-12-08T10:00:00Z"
  }
}
```

**Campos nuevos**:
- `reserved_by`: Identifica quiÃ©n crea la reserva (user-id, system, etc)
- `expires_at`: Fecha de expiraciÃ³n opcional (ISO 8601)
- `reservation_id`: ID del tracking (diferente del movement_id)

---

### 3. Liberar Reserva ğŸ†•

```http
POST /api/v1/stock/reservations/release

{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 10,
  "reservation_id": "res-abc-123",  // ğŸ†• ID de la reserva a liberar
  "reason": "Orden cancelada"
}
```

**Response** (200 OK):
```json
{
  "success": true,
  "new_reserved_quantity": 30,
  "new_available_quantity": 70,
  "errors": []
}
```

**Â¿Por quÃ© `reservation_id`?**
- Si lo proporcionas, el sistema marca esa reserva especÃ­fica como `released`
- Si no lo proporcionas, solo libera el stock (sin actualizar tracking)

---

### 4. Listar Reservas Activas ğŸ†•

```http
GET /api/v1/stock/reservations?item_id=ITEM-001&location_id=WAREHOUSE-MAIN
```

**Query params**:
- `item_id`: Filtrar por item (opcional)
- `location_id`: Filtrar por locaciÃ³n (opcional)
- Si no envÃ­as filtros, trae TODAS las reservas activas

**Response** (200 OK):
```json
{
  "data": [
    {
      "id": "res-abc-123",
      "item_id": "ITEM-001",
      "location_id": "WAREHOUSE-MAIN",
      "quantity": 10,
      "reserved_by": "user-123",
      "reference_type": "sales_order",
      "reference_id": "SO-2024-001",
      "status": "active",
      "expires_at": "2024-12-31T23:59:59Z",
      "created_at": "2024-12-01T10:00:00Z",
      "released_at": null
    },
    {
      "id": "res-def-456",
      "item_id": "ITEM-001",
      "location_id": "WAREHOUSE-MAIN",
      "quantity": 20,
      "reserved_by": "user-456",
      "reference_type": "project",
      "reference_id": "PROJ-2024-001",
      "status": "active",
      "expires_at": null,
      "created_at": "2024-12-02T14:30:00Z",
      "released_at": null
    }
  ],
  "total": 2
}
```

---

### 5. Cancelar Reserva (por ID) ğŸ†•

```http
DELETE /api/v1/stock/reservations/res-abc-123
```

**Response** (200 OK):
```json
{
  "success": true,
  "message": "Reserva cancelada y stock liberado",
  "new_reserved_quantity": 20,
  "new_available_quantity": 80
}
```

**Response** (404 Not Found):
```json
{
  "success": false,
  "message": "Reserva no encontrada"
}
```

**Response** (422 Unprocessable):
```json
{
  "success": false,
  "message": "La reserva ya no estÃ¡ activa"
}
```

**Â¿QuÃ© hace?**:
1. Busca la reserva por ID
2. Valida que estÃ© `active`
3. Libera el stock (crea Movement tipo `RELEASE`)
4. Marca la reserva como `released`

---

## ğŸ­ Flujos Completos

### Flujo: Orden de Venta

```
1. Cliente ordena 10 unidades
   POST /validate â†’ can_reserve: true âœ…

2. Sistema reserva con tracking
   POST /reserve
   {
     "quantity": 10,
     "reserved_by": "user-123",
     "reference_type": "sales_order",
     "reference_id": "SO-2024-001"
   }
   â†’ reservation_id: "res-001" âœ…

3. Frontend lista reservas activas
   GET /reservations?item_id=ITEM-001
   â†’ Muestra quiÃ©n reservÃ³, cuÃ¡ndo, para quÃ©

4a. Orden confirmada â†’ Enviar
    POST /movements/shipment
    quantity: 100 â†’ 90
    reserved: 10 â†’ 0 (consume automÃ¡tico)
    â†’ Reserva queda "released"

4b. Orden cancelada â†’ Cancelar reserva
    DELETE /reservations/res-001
    â†’ Stock liberado + reserva marcada "released"
```

---

### Flujo: Proyecto con ExpiraciÃ³n

```
1. Proyecto solicita 50 unidades (expira en 7 dÃ­as)
   POST /reserve
   {
     "quantity": 50,
     "reserved_by": "project-manager-456",
     "reference_type": "project",
     "reference_id": "PROJ-2024-001",
     "expires_at": "2024-12-15T23:59:59Z"
   }
   â†’ reservation_id: "res-002"

2. Proyecto usa 30, devuelve 20
   POST /movements/shipment (quantity: 30)
   POST /release (quantity: 20, reservation_id: "res-002")

3. Cron job marca expiradas (despuÃ©s del 15/12)
   ReservationRepository::markExpired()
   â†’ Reservas con expires_at < NOW marcadas "expired"
   â†’ Stock liberado automÃ¡ticamente
```

---

### Flujo: MÃºltiples Reservas del Mismo Item

```
Stock inicial: quantity=100, reserved=0, available=100

1. Usuario A reserva 30
   POST /reserve (reserved_by: "user-a", quantity: 30)
   â†’ reserved=30, available=70

2. Usuario B reserva 20
   POST /reserve (reserved_by: "user-b", quantity: 20)
   â†’ reserved=50, available=50

3. Listar reservas
   GET /reservations?item_id=ITEM-001
   â†’ 2 reservas activas (user-a: 30, user-b: 20)

4. Usuario A cancela
   DELETE /reservations/res-a
   â†’ reserved=20, available=80

5. Usuario B envÃ­a
   POST /movements/shipment (quantity: 20)
   â†’ quantity=80, reserved=0, available=80
```

---

## âš™ï¸ ConfiguraciÃ³n de LocaciÃ³n

```http
POST /api/v1/stock/capacity

{
  "location_id": "WAREHOUSE-MAIN",
  "allow_negative_stock": false,
  "max_reservation_percentage": 80,  // MÃ¡ximo 80% del stock puede reservarse
  "max_capacity": 10000
}
```

**Efecto**:
- Si `total_quantity = 100` y `max_reservation_percentage = 80`
- LÃ­mite de reserva = 80 unidades
- Intentar reservar 90 â†’ âŒ Error

---

## âœ… Validaciones

El endpoint `/validate` revisa:

1. **Item existe** (en mÃ³dulo Catalog)
2. **LocaciÃ³n existe** (en mÃ³dulo Locations)
3. **Stock disponible** >= cantidad solicitada
4. **LÃ­mite de reserva** no excedido (si estÃ¡ configurado)

---

## ğŸ§ª Testing

```php
use App\Stock\Domain\ReservationRepository;
use App\Stock\Application\UseCases\CreateReservation\CreateReservationRequest;

// 1. Validar ANTES de reservar
$validation = $this->validateReservation->execute(
    new ReservationValidationRequest(
        itemId: 'ITEM-001',
        locationId: 'WAREHOUSE-MAIN',
        quantity: 10
    )
);

$this->assertTrue($validation->canReserve);
$this->assertEmpty($validation->errors);

// 2. Crear reserva con tracking
$result = $this->createReservation->execute(
    new CreateReservationRequest(
        itemId: 'ITEM-001',
        locationId: 'WAREHOUSE-MAIN',
        quantity: 10,
        reservedBy: 'user-123',              // ğŸ†•
        referenceType: 'sales_order',
        referenceId: 'SO-001',
        expiresAt: '2024-12-31T23:59:59Z'    // ğŸ†•
    )
);

$this->assertTrue($result->success);
$this->assertNotNull($result->reservationId); // ğŸ†•

// 3. Verificar tracking en DB
$reservations = $this->reservationRepo->findActiveByItemAndLocation(
    'ITEM-001',
    'WAREHOUSE-MAIN'
);

$this->assertCount(1, $reservations);
$this->assertEquals('user-123', $reservations[0]->getReservedBy());
$this->assertEquals('active', $reservations[0]->getStatus()->value);

// 4. Liberar por ID
$result = $this->releaseReservation->execute(
    new ReleaseReservationRequest(
        itemId: 'ITEM-001',
        locationId: 'WAREHOUSE-MAIN',
        quantity: 10,
        reservationId: $result->reservationId // ğŸ†•
    )
);

$this->assertTrue($result->success);

// 5. Verificar estado updated
$reservation = $this->reservationRepo->findById($result->reservationId);
$this->assertEquals('released', $reservation->getStatus()->value);
$this->assertNotNull($reservation->getReleasedAt());
```

---

## ğŸ—ï¸ Arquitectura (Modular)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ReservationController              â”‚
â”‚  POST /validate, /reserve, /release         â”‚
â”‚  GET /  (list), DELETE /{id} (cancel)   ğŸ†•  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ValidateReservationUseCase             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 1. StockItemRepository       â”‚ Stock     â”‚
â”‚  â”‚ 2. CatalogGateway            â”‚ Catalog   â”‚
â”‚  â”‚ 3. LocationGateway           â”‚ Locations â”‚
â”‚  â”‚ 4. LocationStockSettings     â”‚ Stock     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      CreateReservationUseCase           ğŸ†•  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 1. ValidateReservation       â”‚           â”‚
â”‚  â”‚ 2. StockMovementService      â”‚           â”‚
â”‚  â”‚ 3. ReservationRepository  ğŸ†• â”‚ Tracking  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ReleaseReservationUseCase          ğŸ†•  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ 1. StockItemRepository       â”‚           â”‚
â”‚  â”‚ 2. StockMovementService      â”‚           â”‚
â”‚  â”‚ 3. ReservationRepository  ğŸ†• â”‚ Tracking  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Independencia de MÃ³dulos**:
- Stock NO conoce Catalog directamente â†’ usa `CatalogGateway` (interface)
- Stock NO conoce Locations directamente â†’ usa `LocationGateway` (interface)
- Los Use Cases **orquestan** mÃºltiples repositorios via interfaces
- ReservationRepository: entidad ligera para tracking del frontend ğŸ†•

---

## ğŸ“Œ Diferencias con Movimientos EstÃ¡ndar

| Aspecto | Movimientos EstÃ¡ndar | Reservations |
|---------|----------------------|--------------|
| **Objetivo** | Modificar stock fÃ­sico | Bloquear stock temporalmente |
| **API** | `POST /movements` | `POST /reservations/*` |
| **ValidaciÃ³n** | Manual | AutomÃ¡tica (combina mÃ³dulos) |
| **Tracking** | Solo Movement | Movement + Reservation ğŸ†• |
| **Frontend** | No sabe quiÃ©n/cuÃ¡ndo | Lista reservas con metadata ğŸ†• |
| **Casos de uso** | EnvÃ­os, recepciones | Ã“rdenes, proyectos, prÃ©stamos |
| **ExpiraciÃ³n** | No | SÃ­ (opcional con `expires_at`) ğŸ†• |
| **CancelaciÃ³n** | No directo | `DELETE /{id}` directo ğŸ†• |

---

## ğŸ’¡ CuÃ¡ndo Usar QuÃ©

### Usa `/reservations` cuando:
- âœ… Necesitas **garantizar stock** antes de enviar
- âœ… Tienes **Ã³rdenes pendientes** (venta, compra)
- âœ… Necesitas **tracking** de quiÃ©n/para quÃ©/cuÃ¡ndo ğŸ†•
- âœ… Quieres **validaciÃ³n automÃ¡tica** (combina Stock + Locations + Catalog)
- âœ… El frontend necesita listar reservas activas ğŸ†•
- âœ… Necesitas **expiraciÃ³n automÃ¡tica** de reservas ğŸ†•

### Usa `/movements` cuando:
- âœ… Modificas stock **fÃ­sico directamente**
- âœ… Recepciones, envÃ­os, ajustes, transferencias
- âœ… No necesitas tracking detallado
- âœ… Operaciones internas del warehouse

---

## ğŸ” Base de Datos

### Tabla: `stock_reservations`

```sql
CREATE TABLE stock_reservations (
  id VARCHAR(36) PRIMARY KEY,
  item_id VARCHAR(36) NOT NULL,
  location_id VARCHAR(36) NOT NULL,
  quantity DECIMAL(15,4) NOT NULL,
  reserved_by VARCHAR(100) NOT NULL,      -- user-id, system, etc
  reference_type VARCHAR(50) NOT NULL,    -- sales_order, project, loan
  reference_id VARCHAR(100) NOT NULL,     -- ID externo
  status ENUM('active','released','expired') DEFAULT 'active',
  expires_at TIMESTAMP NULL,
  created_at TIMESTAMP NULL,
  released_at TIMESTAMP NULL,
  
  INDEX idx_item_location_status (item_id, location_id, status),
  INDEX idx_reference (reference_type, reference_id),
  INDEX idx_expires (status, expires_at)
);
```

**Ãndices optimizados para**:
- Listar reservas activas por item+location
- Buscar por referencia (ej: todas las reservas de una orden)
- Marcar expiradas (cron job)

---

## ğŸš€ PrÃ³ximos Pasos

### 1. Cron Job para ExpiraciÃ³n AutomÃ¡tica

```php
// app/Console/Commands/ExpireReservations.php

use App\Stock\Domain\ReservationRepository;

class ExpireReservations extends Command
{
    public function handle(ReservationRepository $repo): int
    {
        $expired = $repo->markExpired();
        $this->info("Marcadas {$expired} reservas como expiradas");
        
        // TODO: Liberar stock automÃ¡ticamente
        // Por ahora solo marca el estado, no libera reserved_quantity
        
        return 0;
    }
}
```

**Registrar en `Kernel.php`**:
```php
$schedule->command('reservations:expire')->hourly();
```

---

### 2. Notifications

```php
// Alertar cuando una reserva estÃ¡ por expirar (24h antes)
$expiringReservations = $repo->findExpiringIn(hours: 24);

foreach ($expiringReservations as $res) {
    Mail::to($res->getReservedBy())
        ->send(new ReservationExpiringNotification($res));
}
```

---

### 3. Analytics Dashboard

```php
// GET /api/v1/stock/reservations/stats

{
  "active_reservations": 42,
  "total_reserved_quantity": 1250,
  "expiring_soon": 5,
  "by_type": {
    "sales_order": 30,
    "project": 10,
    "loan": 2
  }
}
```

---

### 4. Bulk Operations

```php
// Liberar todas las reservas de una orden completa
POST /api/v1/stock/reservations/release-by-reference

{
  "reference_type": "sales_order",
  "reference_id": "SO-2024-001"
}
```

---

## ğŸ”— Ver TambiÃ©n

- [Extensibility](./08-extensibility) - Tipos custom de movimiento
- [Movements](./03-movements) - Movimientos estÃ¡ndar
- [Location Settings](./04-location-settings) - ConfiguraciÃ³n de lÃ­mites
- [Quick Reference](./09-quick-reference) - GuÃ­a rÃ¡pida
