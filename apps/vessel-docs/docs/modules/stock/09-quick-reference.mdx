---
sidebar_position: 9
---

# Quick Reference (GuÃ­a RÃ¡pida)

Referencia rÃ¡pida de las funcionalidades principales del mÃ³dulo Stock.

## ğŸš€ Endpoints MÃ¡s Usados

### Reservaciones (Flujo Simplificado)

```http
# Validar si puedo reservar
POST /api/v1/stock/reservations/validate
{"item_id": "X", "location_id": "Y", "quantity": 10}

# Reservar
POST /api/v1/stock/reservations/reserve
{"item_id": "X", "location_id": "Y", "quantity": 10, "reference_id": "ORDER-123"}

# Liberar
POST /api/v1/stock/reservations/release
{"item_id": "X", "location_id": "Y", "quantity": 10}
```

### Movimientos EstÃ¡ndar

```http
# RecepciÃ³n
POST /api/v1/stock/movements/receipt
{"item_id": "X", "location_id": "Y", "quantity": 100}

# EnvÃ­o
POST /api/v1/stock/movements/shipment
{"item_id": "X", "location_id": "Y", "quantity": 50}

# DevoluciÃ³n
POST /api/v1/stock/movements
{"type": "return", "item_id": "X", "location_id": "Y", "quantity": 5}

# Ajuste
POST /api/v1/stock/movements/adjustment
{"item_id": "X", "location_id": "Y", "quantity": 10, "type": "in"}
```

---

## ğŸ“Š Tipos de Movimiento

### EstÃ¡ndar (18 tipos)

| Tipo | Efecto | Uso |
|------|--------|-----|
| `receipt` | â• Suma | RecepciÃ³n de mercancÃ­a |
| `return` | â• Suma | DevoluciÃ³n de cliente |
| `shipment` | â– Resta | EnvÃ­o/despacho |
| `reserve` | ğŸ”’ Bloquea | Reserva para orden |
| `release` | ğŸ”“ Libera | Libera reserva |
| `adjustment_in` | â• Suma | Ajuste positivo |
| `adjustment_out` | â– Resta | Ajuste negativo |
| `damage` | â– Resta | DaÃ±o/merma |
| `transfer_out` | â– Resta | Transferencia salida |
| `transfer_in` | â• Suma | Transferencia entrada |

### Custom (Extensible)

```http
POST /api/v1/stock/movements
{
  "type": "custom",
  "reference_type": "customer_loan",  # â† Identifica el handler
  "item_id": "X",
  "quantity": 5
}
```

Handlers incluidos:
- `customer_loan` / `loan_return` - PrÃ©stamos
- `consignment_out` / `consignment_return` - ConsignaciÃ³n

---

## ğŸ”§ ConfiguraciÃ³n de LocaciÃ³n

```http
POST /api/v1/stock/capacity

{
  "location_id": "WAREHOUSE-MAIN",
  "allow_negative_stock": false,
  "max_reservation_percentage": 80,
  "max_capacity": 10000
}
```

**Efectos**:
- `allow_negative_stock`: Permite stock negativo
- `max_reservation_percentage`: LÃ­mite de reserva (% del total)
- `max_capacity`: Capacidad mÃ¡xima de la locaciÃ³n

---

## ğŸ“¦ Modelo de Datos

### Stock Item

```json
{
  "id": "stock-abc-123",
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 100,           // Total
  "reserved_quantity": 30,   // Bloqueado
  "available_quantity": 70   // Disponible = quantity - reserved
}
```

### Movement

```json
{
  "id": "mov-xyz-456",
  "type": "reserve",
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 10,
  "status": "completed",
  "reference_type": "sales_order",
  "reference_id": "SO-2024-001",
  "reason": "Reserva para venta",
  "meta": {},
  "created_at": "2024-12-08T10:00:00Z",
  "processed_at": "2024-12-08T10:00:01Z"
}
```

---

## ğŸ¯ Casos de Uso Comunes

### 1. Verificar Disponibilidad

```http
POST /api/v1/stock/reservations/validate
{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 50
}
```

**Response incluye**:
- âœ… `can_reserve`: true/false
- ğŸ“Š `available_quantity`: Disponible ahora
- ğŸ“Š `reserved_quantity`: Bloqueado
- ğŸ“Š `max_reservation_allowed`: LÃ­mite configurado
- â„¹ï¸ `item_info`: Info del catÃ¡logo
- â„¹ï¸ `location_info`: Info de la locaciÃ³n

---

### 2. Reservar para Orden de Venta

```http
POST /api/v1/stock/reservations/reserve
{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 50,
  "reference_type": "sales_order",
  "reference_id": "SO-2024-001",
  "reason": "Orden de venta #001"
}
```

**Efecto**:
- `reserved_quantity` += 50
- `available_quantity` -= 50
- `quantity` sin cambios

---

### 3. Enviar (Consume Reserva)

```http
POST /api/v1/stock/movements/shipment
{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 50,
  "reference_type": "sales_order",
  "reference_id": "SO-2024-001"
}
```

**Efecto**:
- `quantity` -= 50
- `reserved_quantity` -= 50 (si habÃ­a reserva)
- `available_quantity` sin cambios

---

### 4. Cancelar Orden (Liberar)

```http
POST /api/v1/stock/reservations/release
{
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 50,
  "reference_id": "SO-2024-001",
  "reason": "Orden cancelada"
}
```

**Efecto**:
- `reserved_quantity` -= 50
- `available_quantity` += 50
- `quantity` sin cambios

---

### 5. DevoluciÃ³n de Cliente

```http
POST /api/v1/stock/movements
{
  "type": "return",
  "item_id": "ITEM-001",
  "location_id": "WAREHOUSE-MAIN",
  "quantity": 5,
  "reference_type": "return_order",
  "reference_id": "RET-2024-001",
  "reason": "Cliente insatisfecho"
}
```

**Efecto**:
- `quantity` += 5
- `available_quantity` += 5

---

## ğŸ› ï¸ Extender con Handler Custom

### 1. Crear Handler

```php title="app/Stock/Infrastructure/Handlers/MyHandler.php"
class MyHandler implements MovementHandlerInterface
{
    public function supports(string $type): bool
    {
        return $type === 'my_custom_type';
    }

    public function validate(Movement $m, StockItem $s): void
    {
        if ($s->getQuantity() < $m->getQuantity()) {
            throw new \DomainException('Insuficiente');
        }
    }

    public function handle(Movement $m, StockItem $s): StockItem
    {
        return $s->adjustQuantity(-$m->getQuantity());
    }
}
```

### 2. Registrar

```php title="StockServiceProvider.php"
$registry->register(new MyHandler());
```

### 3. Usar

```http
POST /api/v1/stock/movements
{
  "type": "custom",
  "reference_type": "my_custom_type",
  "item_id": "X",
  "quantity": 10
}
```

---

## ğŸ“ˆ Estados del Stock

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Total Stock: 100           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Reserved: 30 ğŸ”’            â”‚ â† Bloqueado para Ã³rdenes
â”‚  Available: 70 âœ…           â”‚ â† Libre para reservar/enviar
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Available = Total - Reserved
```

### Flujo de Reserva â†’ EnvÃ­o

```
1. Estado inicial:
   Total: 100, Reserved: 0, Available: 100

2. RESERVE 30:
   Total: 100, Reserved: 30, Available: 70

3. SHIPMENT 30:
   Total: 70, Reserved: 0, Available: 70
   (Consume de reserved primero, luego de total)

4. RECEIPT 50:
   Total: 120, Reserved: 0, Available: 120
```

---

## ğŸ” Consultas Ãštiles

```http
# Stock actual por locaciÃ³n
GET /api/v1/stock/current/location/{locationId}

# Resumen de locaciÃ³n (combina con Locations module)
GET /api/v1/stock/locations/{locationId}/summary

# ConfiguraciÃ³n de capacidad
GET /api/v1/stock/capacity/{locationId}

# Historial de movimientos
GET /api/v1/stock/movements?item_id=X&location_id=Y

# Tipos de movimiento soportados
GET /api/v1/stock/movements/types
```

---

## âš ï¸ Errores Comunes

### 422: Stock insuficiente

```json
{
  "errors": ["Stock disponible insuficiente. Disponible: 10, solicitado: 30"]
}
```

**SoluciÃ³n**: Validar disponibilidad antes con `/reservations/validate`

---

### 422: Excede lÃ­mite de reserva

```json
{
  "errors": ["Excede el lÃ­mite de reserva (80%)"]
}
```

**SoluciÃ³n**: Ajustar `max_reservation_percentage` en configuraciÃ³n de locaciÃ³n

---

### 422: Item no existe

```json
{
  "errors": ["Item 'ITEM-999' no existe en catÃ¡logo"]
}
```

**SoluciÃ³n**: Verificar que el item existe en el mÃ³dulo Catalog

---

## ğŸ“š MÃ¡s InformaciÃ³n

- [Reservations](./07-reservations) - Flujo completo de reservas
- [Extensibility](./08-extensibility) - Tipos custom de movimiento
- [Movements](./03-movements) - Movimientos estÃ¡ndar
- [Location Settings](./04-location-settings) - ConfiguraciÃ³n de locaciones
