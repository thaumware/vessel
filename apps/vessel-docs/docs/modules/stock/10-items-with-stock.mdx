---
sidebar_position: 10
---

# API Reference - Items con Stock

Documentaci√≥n completa de los endpoints para consultar items del cat√°logo enriquecidos con informaci√≥n de stock.

## üéØ Descripci√≥n General

El m√≥dulo de Stock se integra con el Cat√°logo para proporcionar endpoints que:
- Enriquecen items del cat√°logo con informaci√≥n de stock agregada
- Permiten filtrar items por ubicaci√≥n, categor√≠a y nivel de stock
- Incluyen nombres de t√©rminos de taxonom√≠a
- Facilitan la b√∫squeda de items con disponibilidad

---

## üìã Endpoint Principal: Items con Stock

### `GET /api/v1/items/read`

Endpoint mejorado del Cat√°logo que soporta enriquecimiento con stock y m√∫ltiples filtros.

#### Query Parameters

| Par√°metro | Tipo | Descripci√≥n |
|-----------|------|-------------|
| `with_stock` | boolean | Incluir resumen de stock agregado |
| `with_terms` | boolean | Incluir nombres de t√©rminos de taxonom√≠a |
| `term_id` | uuid | Filtrar por t√©rmino/categor√≠a espec√≠fica |
| `location_id` | uuid | Filtrar items con stock en ubicaci√≥n |
| `low_stock` | boolean | Solo items con stock bajo |
| `max_quantity` | int | Umbral de stock bajo (default: 5) |
| `page` | int | P√°gina (paginaci√≥n est√°ndar) |
| `per_page` | int | Items por p√°gina |

#### Response sin Enriquecimiento

```json
{
  "data": [
    {
      "id": "item-123",
      "name": "Mouse USB Logitech",
      "description": "Mouse √≥ptico inal√°mbrico",
      "uom_id": "uom-unit",
      "status": "active",
      "term_ids": ["term-electronics"]
    }
  ],
  "total": 150,
  "page": 1,
  "per_page": 50,
  "last_page": 3
}
```

#### Response con `?with_stock=true`

```json
{
  "data": [
    {
      "id": "item-123",
      "name": "Mouse USB Logitech",
      "description": "Mouse √≥ptico inal√°mbrico",
      "uom_id": "uom-unit",
      "status": "active",
      "term_ids": ["term-electronics"],
      "stock_summary": {
        "total_quantity": 150,
        "reserved_quantity": 30,
        "available_quantity": 120,
        "location_count": 3,
        "locations": ["Bodega A", "Bodega B", "Taller Central"]
      }
    }
  ],
  "total": 150,
  "page": 1,
  "per_page": 50,
  "last_page": 3
}
```

#### Response con `?with_terms=true`

```json
{
  "data": [
    {
      "id": "item-123",
      "name": "Mouse USB Logitech",
      "term_ids": ["term-electronics"],
      "terms": [
        {
          "id": "term-electronics",
          "name": "Electr√≥nica",
          "slug": "electronica",
          "vocabulary_id": "vocab-categories"
        }
      ]
    }
  ]
}
```

---

## üîç B√∫squeda de Items con Stock

### `GET /api/v1/stock/catalog/search`

Busca items en el cat√°logo por nombre o descripci√≥n, e incluye autom√°ticamente informaci√≥n de stock.

#### Query Parameters

| Par√°metro | Tipo | Requerido | Descripci√≥n |
|-----------|------|-----------|-------------|
| `q` | string | ‚úÖ | T√©rmino de b√∫squeda |
| `limit` | int | ‚ùå | M√°ximo de resultados (default: 50) |

#### Request

```http
GET /api/v1/stock/catalog/search?q=mouse&limit=20
```

#### Response

```json
{
  "success": true,
  "data": [
    {
      "id": "item-123",
      "name": "Mouse USB Logitech",
      "description": "Mouse √≥ptico inal√°mbrico",
      "uom_id": "uom-unit",
      "status": "active",
      "stock": {
        "total_quantity": 150,
        "available_quantity": 120,
        "reserved_quantity": 30,
        "locations": [
          {
            "location_id": "loc-bodega-a",
            "quantity": 100,
            "available": 80
          },
          {
            "location_id": "loc-bodega-b",
            "quantity": 50,
            "available": 40
          }
        ]
      }
    }
  ],
  "count": 1
}
```

#### Errores

```json
// 422 - Par√°metro q faltante
{
  "message": "The q field is required.",
  "errors": {
    "q": ["The q field is required."]
  }
}
```

---

## üìä Casos de Uso

### 1. Mostrar Items con Stock en Tabla

```http
GET /api/v1/items/read?with_stock=true&page=1&per_page=50
```

**Frontend puede mostrar:**
- Total en stock
- Disponible para vender
- Reservado
- N√∫mero de ubicaciones
- Nombres de ubicaciones

### 2. Filtrar Items por Categor√≠a

```http
GET /api/v1/items/read?term_id=term-electronics&with_stock=true
```

**Uso:** Mostrar solo items de categor√≠a "Electr√≥nica" con su stock.

### 3. Ver Items en Bodega Espec√≠fica

```http
GET /api/v1/items/read?location_id=loc-bodega-a&with_stock=true
```

**Uso:** Dashboard de bodega mostrando qu√© items hay en esa ubicaci√≥n.

### 4. Alertas de Stock Bajo

```http
GET /api/v1/items/read?low_stock=true&max_quantity=10&with_stock=true
```

**Uso:** Alertas de reabastecimiento, items con menos de 10 unidades disponibles.

### 5. Buscar Item por Nombre

```http
GET /api/v1/stock/catalog/search?q=laptop&limit=10
```

**Uso:** Buscador con autocompletado mostrando stock disponible.

### 6. Combinar Todo

```http
GET /api/v1/items/read?with_stock=true&with_terms=true&term_id=term-electronics&low_stock=true&max_quantity=5
```

**Uso:** Items de categor√≠a "Electr√≥nica" con stock bajo, mostrando nombres de categor√≠as.

---

## üõ†Ô∏è Estructura de Datos

### Stock Summary (cuando `with_stock=true`)

```typescript
interface StockSummary {
  total_quantity: number;        // Cantidad total en todas las ubicaciones
  reserved_quantity: number;     // Cantidad reservada (bloqueada)
  available_quantity: number;    // Disponible = total - reserved
  location_count: number;        // N√∫mero de ubicaciones con stock
  locations: string[];           // Nombres de ubicaciones
}
```

### Term (cuando `with_terms=true`)

```typescript
interface Term {
  id: string;              // UUID del t√©rmino
  name: string;            // Nombre del t√©rmino
  slug: string;            // Slug para URLs
  vocabulary_id: string;   // ID del vocabulario padre
}
```

### Stock por Ubicaci√≥n (en b√∫squeda)

```typescript
interface LocationStock {
  location_id: string;     // ID de la ubicaci√≥n
  quantity: number;        // Cantidad total en esa ubicaci√≥n
  available: number;       // Cantidad disponible en esa ubicaci√≥n
}
```

---

## üîÑ Flujo de Integraci√≥n

### Frontend ‚Üí Backend

```mermaid
graph LR
    A[Frontend] -->|GET /items/read?with_stock=true| B[ItemController]
    B -->|ListItems| C[ItemRepository]
    C -->|Items[]| B
    B -->|enrichWithStock| D[StockEnrichmentService]
    D -->|Consulta stock_items| E[Database]
    E -->|Stock agregado| D
    D -->|Items + stock_summary| B
    B -->|JSON| A
```

### Servicios Involucrados

1. **ItemController** - Controlador principal
2. **StockEnrichmentService** - Agrega informaci√≥n de stock
3. **TaxonomyEnrichmentService** - Agrega nombres de t√©rminos
4. **ListItems** - Caso de uso de listado del cat√°logo

---

## üìà Performance

### Optimizaciones Implementadas

1. **Agregaci√≥n en DB**: Stock se agrega con `SUM()` y `COUNT()` directamente en la base de datos
2. **Batch Loading**: T√©rminos y ubicaciones se cargan en lote, no por item
3. **Filtros Tempranos**: Filtros aplicados antes de enriquecer para reducir procesamiento
4. **Lazy Loading**: Stock y t√©rminos solo se cargan si se solicitan

### Recomendaciones

- Usar paginaci√≥n (`per_page` <= 100)
- Solicitar solo enriquecimientos necesarios
- Filtrar antes de enriquecer cuando sea posible
- Cachear resultados de b√∫squeda en frontend

---

## ‚ö° Ejemplos Completos

### Dashboard de Inventario

```typescript
// Obtener items con stock bajo y categor√≠as
const response = await fetch(
  '/api/v1/items/read?with_stock=true&with_terms=true&low_stock=true&max_quantity=10'
);

const { data } = await response.json();

data.forEach(item => {
  console.log(`${item.name}: ${item.stock_summary.available_quantity} disponibles`);
  console.log(`Categor√≠as: ${item.terms.map(t => t.name).join(', ')}`);
  console.log(`Ubicaciones: ${item.stock_summary.locations.join(', ')}`);
});
```

### Buscador con Autocompletado

```typescript
// Buscar mientras el usuario escribe
const searchItems = async (query: string) => {
  const response = await fetch(
    `/api/v1/stock/catalog/search?q=${encodeURIComponent(query)}&limit=10`
  );
  
  const { data } = await response.json();
  
  return data.map(item => ({
    label: item.name,
    value: item.id,
    stock: item.stock.available_quantity,
    locations: item.stock.locations.length
  }));
};
```

### Filtro por Bodega

```typescript
// Mostrar items de una bodega espec√≠fica
const getWarehouseItems = async (locationId: string) => {
  const response = await fetch(
    `/api/v1/items/read?location_id=${locationId}&with_stock=true&per_page=100`
  );
  
  const { data } = await response.json();
  
  return data;
};
```

---

## üêõ Troubleshooting

### Item sin stock_summary

**Problema:** `stock_summary` no aparece en la respuesta.

**Soluci√≥n:** Asegurar que incluye `?with_stock=true` en el query string.

### Filtro por location_id no funciona

**Problema:** Filtrar por `location_id` devuelve lista vac√≠a.

**Soluci√≥n:** El item debe tener al menos una entrada en `stock_items` para esa ubicaci√≥n. Verificar con:

```http
GET /api/v1/stock/items/read?location_id={locationId}
```

### terms array vac√≠o

**Problema:** `terms` aparece vac√≠o aunque el item tiene `term_ids`.

**Soluci√≥n:** 
1. Verificar que us√≥ `?with_terms=true`
2. Confirmar que los t√©rminos existen en `taxonomy_terms`
3. Verificar relaciones en `catalog_item_terms`

### B√∫squeda no encuentra items

**Problema:** `/catalog/search` no devuelve resultados esperados.

**Soluci√≥n:** La b√∫squeda es con `LIKE %term%` en nombre y descripci√≥n. Verificar:
- Ortograf√≠a correcta
- Items no est√°n soft-deleted
- Term de b√∫squeda es suficientemente espec√≠fico

---

## üìö Ver Tambi√©n

- [Stock Items](./02-stock-items) - CRUD de stock items
- [Reservations](./07-reservations) - Reservas de stock
- [Quick Reference](./09-quick-reference) - Gu√≠a r√°pida del m√≥dulo
- [Catalog Module](../catalog) - M√≥dulo de cat√°logo (si existe doc)
