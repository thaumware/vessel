---
sidebar_position: 5
---
import ApiPlayground from '@site/src/components/ApiPlayground';

# Stock (Inventario)

MÃ³dulo de gestiÃ³n de inventario con arquitectura hexagonal. Soporta mÃºltiples adaptadores intercambiables y un sistema flexible de movimientos.

## CaracterÃ­sticas

- âœ… Entidades inmutables con ID obligatorio
- âœ… Sistema flexible de movimientos (15+ tipos)
- âœ… GestiÃ³n de lotes con trazabilidad
- âœ… ValidaciÃ³n de capacidad por ubicaciÃ³n
- âœ… Reserva y liberaciÃ³n de stock
- âœ… IntegraciÃ³n con catÃ¡logo via `CatalogGatewayInterface`
- âœ… Adaptador InMemory para desarrollo/testing

---

## ğŸ“¦ Stock Items

### Listar items de stock

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/items"
  description="Lista todos los items de stock con filtros opcionales"
/>

**Query params opcionales:**
- `location_id` - Filtrar por ubicaciÃ³n
- `sku` - Filtrar por SKU
- `catalog_item_id` - Filtrar por item de catÃ¡logo
- `with_catalog=true` - Incluir datos del catÃ¡logo
- `limit` - LÃ­mite de resultados (default: 50)
- `offset` - Offset para paginaciÃ³n

### Obtener item de stock

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/items/{id}"
  params={{ id: 'uuid-del-item' }}
  description="Obtiene un item de stock por ID"
/>

### Crear item de stock

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items"
  body={{
    sku: 'PROD-001',
    catalog_item_id: 'uuid-del-producto',
    catalog_origin: 'internal_catalog',
    location_id: 'uuid-de-ubicacion',
    location_type: 'warehouse',
    quantity: 100,
    lot_number: 'LOT-2024-001',
    expiration_date: '2025-12-31'
  }}
  description="Crea un nuevo item de stock (ID generado automÃ¡ticamente)"
/>

### Actualizar item de stock

<ApiPlayground
  method="PUT"
  endpoint="/v1/stock/items/{id}"
  params={{ id: 'uuid-del-item' }}
  body={{
    quantity: 150,
    lot_number: 'LOT-2024-002'
  }}
  description="Actualiza un item de stock existente"
/>

### Eliminar item de stock

<ApiPlayground
  method="DELETE"
  endpoint="/v1/stock/items/{id}"
  params={{ id: 'uuid-del-item' }}
  description="Elimina un item de stock"
/>

---

## ğŸ“Š Operaciones de Stock

### Ajustar cantidad

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items/{id}/adjust"
  params={{ id: 'uuid-del-item' }}
  body={{
    sku: 'PROD-001',
    location_id: 'uuid-de-ubicacion',
    delta: 50,
    reason: 'RecepciÃ³n de mercancÃ­a'
  }}
  description="Ajusta la cantidad de stock (positivo o negativo)"
/>

### Reservar stock

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items/{id}/reserve"
  params={{ id: 'uuid-del-item' }}
  body={{ quantity: 10 }}
  description="Reserva una cantidad de stock para una orden"
/>

### Liberar reserva

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items/{id}/release"
  params={{ id: 'uuid-del-item' }}
  body={{ quantity: 5 }}
  description="Libera stock previamente reservado"
/>

---

## ğŸšš Movimientos de Stock

Sistema flexible para registrar cualquier tipo de movimiento de inventario.

### Tipos de Movimiento

| Tipo | CÃ³digo | Efecto | DescripciÃ³n |
|------|--------|--------|-------------|
| RecepciÃ³n | `RECEIPT` | +stock | Ingreso de mercancÃ­a |
| EnvÃ­o | `SHIPMENT` | -stock | Salida por venta/envÃ­o |
| Ajuste entrada | `ADJUSTMENT_IN` | +stock | Ajuste positivo de inventario |
| Ajuste salida | `ADJUSTMENT_OUT` | -stock | Ajuste negativo de inventario |
| Transfer Out | `TRANSFER_OUT` | -stock | Salida por transferencia |
| Transfer In | `TRANSFER_IN` | +stock | Entrada por transferencia |
| Reserva | `RESERVE` | reserva | Reserva para orden |
| LiberaciÃ³n | `RELEASE` | libera | Libera reserva |
| Conteo | `COUNT` | neutral | Registro de conteo fÃ­sico |
| DaÃ±o | `DAMAGE` | -stock | PÃ©rdida por daÃ±o |
| ExpiraciÃ³n | `EXPIRATION` | -stock | PÃ©rdida por vencimiento |
| Retorno cliente | `CUSTOMER_RETURN` | +stock | DevoluciÃ³n de cliente |
| Retorno proveedor | `SUPPLIER_RETURN` | -stock | DevoluciÃ³n a proveedor |
| InstalaciÃ³n | `INSTALLATION` | -stock | Consumo por instalaciÃ³n |

### Crear movimiento

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/movements"
  body={{
    type: 'RECEIPT',
    sku: 'PROD-001',
    location_id: 'uuid-ubicacion',
    quantity: 100,
    reference: 'PO-2024-001',
    lot_number: 'LOT-2024-001',
    expiration_date: '2025-12-31',
    reason: 'RecepciÃ³n de orden de compra'
  }}
  description="Crea y procesa un movimiento de stock"
/>

### Listar movimientos

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/movements"
  description="Lista movimientos con filtros opcionales"
/>

**Query params:**
- `sku` - Filtrar por SKU
- `location_id` - Filtrar por ubicaciÃ³n
- `type` - Filtrar por tipo (RECEIPT, SHIPMENT, etc.)
- `status` - Filtrar por estado (PENDING, COMPLETED, CANCELLED)
- `from` / `to` - Rango de fechas

### Estados de Movimiento

| Estado | DescripciÃ³n |
|--------|-------------|
| `PENDING` | Creado, pendiente de procesar |
| `COMPLETED` | Procesado exitosamente |
| `CANCELLED` | Cancelado |
| `FAILED` | Error al procesar |

### Transferencias entre ubicaciones

Para transferir stock entre ubicaciones, se crean dos movimientos vinculados:

```bash
# 1. Salida del origen
curl -X POST http://localhost:8000/api/v1/stock/movements \
  -H "Content-Type: application/json" \
  -d '{
    "type": "TRANSFER_OUT",
    "sku": "PROD-001",
    "location_id": "origen-uuid",
    "quantity": 50,
    "reference": "TRANSFER-001"
  }'

# 2. Entrada al destino
curl -X POST http://localhost:8000/api/v1/stock/movements \
  -H "Content-Type: application/json" \
  -d '{
    "type": "TRANSFER_IN",
    "sku": "PROD-001",
    "location_id": "destino-uuid",
    "quantity": 50,
    "reference": "TRANSFER-001"
  }'
```

---

## ğŸ“¦ GestiÃ³n de Lotes

Trazabilidad completa de lotes con fechas de expiraciÃ³n.

### Crear lote

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/lots"
  body={{
    lot_number: 'LOT-2024-001',
    sku: 'PROD-001',
    expiration_date: '2025-12-31',
    manufacture_date: '2024-01-15',
    supplier_lot: 'PROV-LOT-123'
  }}
  description="Registra un nuevo lote"
/>

### Listar lotes

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/lots"
  description="Lista lotes con filtros opcionales"
/>

**Query params:**
- `sku` - Filtrar por SKU
- `status` - `active`, `expired`, `depleted`
- `expiring_before` - Lotes que vencen antes de fecha

### Estados de Lote

| Estado | DescripciÃ³n |
|--------|-------------|
| `active` | Lote vigente y disponible |
| `expired` | Lote vencido |
| `depleted` | Lote sin stock restante |
| `quarantine` | En cuarentena |

---

## ğŸ“Š Capacidad de Ubicaciones

ValidaciÃ³n y control de capacidad por ubicaciÃ³n.

### Consultar capacidad

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/capacity/{locationId}"
  params={{ locationId: 'uuid-ubicacion' }}
  description="Obtiene estadÃ­sticas de capacidad de una ubicaciÃ³n"
/>

**Respuesta:**
```json
{
  "current_quantity": 75,
  "max_quantity": 100,
  "available_quantity": 25,
  "usage_percent": 75.0,
  "unique_skus": 3,
  "settings": {
    "allow_mixed_skus": true,
    "allow_mixed_lots": true,
    "fifo_enforced": false
  }
}
```

### Validar ingreso

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/capacity/{locationId}/validate"
  params={{ locationId: 'uuid-ubicacion' }}
  body={{
    quantity: 50,
    sku: 'PROD-001',
    item_type: 'regular'
  }}
  description="Valida si una ubicaciÃ³n puede aceptar stock"
/>

**CÃ³digos de error:**
- `EXCEEDS_MAX_QUANTITY` - Supera capacidad mÃ¡xima
- `MIXED_SKUS_NOT_ALLOWED` - UbicaciÃ³n no permite mezclar SKUs
- `MIXED_LOTS_NOT_ALLOWED` - UbicaciÃ³n no permite mezclar lotes
- `ITEM_TYPE_NOT_ALLOWED` - Tipo de item no permitido

---

## ğŸ”„ Cambio de Adaptador

Cambio dinÃ¡mico de repositorio via header HTTP:

```bash
# Eloquent (default - base de datos)
curl http://localhost/api/v1/stock/items

# InMemory (testing/demos)
curl http://localhost/api/v1/stock/items -H "X-STOCK-ADAPTER: local"
```

| Header Value | Repositorio | Uso |
|--------------|-------------|-----|
| `eloquent` | Base de datos | ProducciÃ³n |
| `local` | InMemory | Testing, demos |

---

## ğŸ—ï¸ Arquitectura

```
Stock/
â”œâ”€â”€ Domain/
â”‚   â”œâ”€â”€ Entities/
â”‚   â”‚   â”œâ”€â”€ StockItem.php      # Item de inventario
â”‚   â”‚   â”œâ”€â”€ Movement.php       # Movimiento de stock
â”‚   â”‚   â””â”€â”€ Lot.php            # Lote con trazabilidad
â”‚   â”œâ”€â”€ ValueObjects/
â”‚   â”‚   â”œâ”€â”€ MovementType.php   # Enum de tipos
â”‚   â”‚   â”œâ”€â”€ MovementStatus.php # Enum de estados
â”‚   â”‚   â””â”€â”€ ValidationResult.php
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ StockMovementService.php  # Procesa movimientos
â”‚   â”‚   â””â”€â”€ StockCapacityService.php  # Valida capacidad
â”‚   â””â”€â”€ Interfaces/
â”‚       â”œâ”€â”€ StockItemRepositoryInterface.php
â”‚       â”œâ”€â”€ MovementRepositoryInterface.php
â”‚       â””â”€â”€ LotRepositoryInterface.php
â”œâ”€â”€ Application/
â”‚   â”œâ”€â”€ UseCases/              # Casos de uso
â”‚   â””â”€â”€ Factories/
â”‚       â””â”€â”€ MovementFactory.php # Crea movimientos
â””â”€â”€ Infrastructure/
    â”œâ”€â”€ In/Http/               # Controllers
    â””â”€â”€ Out/Persistence/       # Repositorios
```

### Flujo de un movimiento

```
Request â†’ Controller â†’ MovementFactory.create()
                            â†“
                       Movement (entity)
                            â†“
                    StockMovementService.validate()
                            â†“
                    StockMovementService.process()
                            â†“
                    ProcessMovementResult
```

---

## ğŸ“ Modelos de Datos

### StockItem

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| `id` | UUID | Identificador Ãºnico |
| `sku` | string | CÃ³digo SKU |
| `catalog_item_id` | UUID? | Referencia al catÃ¡logo |
| `location_id` | UUID | UbicaciÃ³n del stock |
| `quantity` | int | Cantidad total |
| `reserved_quantity` | int | Cantidad reservada |
| `lot_number` | string? | NÃºmero de lote |
| `expiration_date` | date? | Fecha de expiraciÃ³n |

**Campos calculados:** `available_quantity`, `is_expired`, `is_lot_tracked`

### Movement

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| `id` | UUID | Identificador Ãºnico |
| `type` | MovementType | Tipo de movimiento |
| `status` | MovementStatus | Estado actual |
| `sku` | string | SKU afectado |
| `location_id` | UUID | UbicaciÃ³n |
| `quantity` | int | Cantidad movida |
| `reference` | string? | Referencia externa (PO, SO, etc.) |
| `lot_number` | string? | Lote asociado |
| `balance_after` | int? | Balance resultante |
| `reason` | string? | Motivo del movimiento |

### Lot

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| `id` | UUID | Identificador Ãºnico |
| `lot_number` | string | NÃºmero de lote |
| `sku` | string | SKU del producto |
| `status` | LotStatus | Estado del lote |
| `expiration_date` | date? | Fecha de vencimiento |
| `manufacture_date` | date? | Fecha de fabricaciÃ³n |
| `initial_quantity` | int | Cantidad inicial |
| `current_quantity` | int | Cantidad actual |

---

## âš™ï¸ Location Stock Settings

ConfiguraciÃ³n de capacidad y restricciones por ubicaciÃ³n.

### Obtener configuraciÃ³n

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/locations/{locationId}/settings"
  params={{ locationId: 'uuid-ubicacion' }}
  description="Obtiene la configuraciÃ³n de stock de una ubicaciÃ³n"
/>

### Crear/Actualizar configuraciÃ³n

<ApiPlayground
  method="PUT"
  endpoint="/v1/stock/locations/{locationId}/settings"
  params={{ locationId: 'uuid-ubicacion' }}
  body={{
    max_quantity: 1000,
    max_weight: 500.0,
    max_volume: 100.0,
    allowed_item_types: ['regular', 'fragile'],
    allow_mixed_lots: false,
    allow_mixed_skus: true,
    fifo_enforced: true,
    is_active: true
  }}
  description="Configura restricciones de stock para una ubicaciÃ³n"
/>

### Campos de configuraciÃ³n

| Campo | Tipo | DescripciÃ³n |
|-------|------|-------------|
| `max_quantity` | int? | Capacidad mÃ¡xima de unidades |
| `max_weight` | float? | Peso mÃ¡ximo (kg) |
| `max_volume` | float? | Volumen mÃ¡ximo (mÂ³) |
| `allowed_item_types` | array? | Tipos de items permitidos |
| `allow_mixed_lots` | bool | Permite mezclar lotes (default: true) |
| `allow_mixed_skus` | bool | Permite mezclar SKUs (default: true) |
| `fifo_enforced` | bool | Requiere FIFO (default: false) |
| `is_active` | bool | Estado activo |

---

## ğŸ§ª Testing

```bash
# Tests del mÃ³dulo Stock
cd modules/catalog
./vendor/bin/phpunit --testsuite Stock --testdox

# Tests especÃ­ficos
./vendor/bin/phpunit --filter StockMovementServiceTest
./vendor/bin/phpunit --filter MovementTest
```

---

## ğŸ”— IntegraciÃ³n con CatÃ¡logo

```php
interface CatalogGatewayInterface
{
    public function getItemData(string $catalogItemId, string $origin): ?array;
    public function attachCatalogData(array $stockItems): array;
}
```

Usa `with_catalog=true` en endpoints para incluir datos del catÃ¡logo en respuestas.

---

## ğŸ“ Ejemplos curl

### Crear recepciÃ³n de mercancÃ­a

```bash
curl -X POST http://localhost:8000/api/v1/stock/movements \
  -H "Content-Type: application/json" \
  -d '{
    "type": "RECEIPT",
    "sku": "LAPTOP-001",
    "location_id": "warehouse-uuid",
    "quantity": 50,
    "reference": "PO-2024-001",
    "lot_number": "LOT-2024-001"
  }'
```

### Consultar capacidad disponible

```bash
curl http://localhost:8000/api/v1/stock/capacity/warehouse-uuid
```

### Listar movimientos del dÃ­a

```bash
curl "http://localhost:8000/api/v1/stock/movements?from=2024-01-15&to=2024-01-15"
```
