---
sidebar_position: 5
---
import ApiPlayground from '@site/src/components/ApiPlayground';

# Stock (Inventario)

M√≥dulo de gesti√≥n de inventario con arquitectura hexagonal. Soporta m√∫ltiples adaptadores (Eloquent/InMemory) intercambiables via header HTTP.

## Caracter√≠sticas

- ‚úÖ Entidades inmutables con ID obligatorio
- ‚úÖ Integraci√≥n con cat√°logo via `CatalogGatewayInterface`
- ‚úÖ Soporte para lotes, n√∫meros de serie, fechas de expiraci√≥n
- ‚úÖ Reserva y liberaci√≥n de stock
- ‚úÖ Adaptador InMemory para desarrollo/testing

---

## üì¶ Stock Items

### Listar items de stock

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/items"
  description="Lista todos los items de stock con filtros opcionales"
/>

**Query params opcionales:**
- `location_id` - Filtrar por ubicaci√≥n
- `sku` - Filtrar por SKU
- `catalog_item_id` - Filtrar por item de cat√°logo
- `with_catalog=true` - Incluir datos del cat√°logo
- `limit` - L√≠mite de resultados (default: 50)
- `offset` - Offset para paginaci√≥n

### Obtener item de stock

<ApiPlayground
  method="GET"
  endpoint="/v1/stock/items/{id}"
  params={{ id: 'uuid-del-item' }}
  description="Obtiene un item de stock por ID"
/>

### Crear item de stock

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items"
  body={{
    sku: 'PROD-001',
    catalog_item_id: 'uuid-del-producto',
    catalog_origin: 'internal_catalog',
    location_id: 'uuid-de-ubicacion',
    location_type: 'warehouse',
    quantity: 100,
    lot_number: 'LOT-2024-001',
    expiration_date: '2025-12-31'
  }}
  description="Crea un nuevo item de stock (ID generado autom√°ticamente)"
/>

### Actualizar item de stock

<ApiPlayground
  method="PUT"
  endpoint="/v1/stock/items/{id}"
  params={{ id: 'uuid-del-item' }}
  body={{
    quantity: 150,
    lot_number: 'LOT-2024-002'
  }}
  description="Actualiza un item de stock existente"
/>

### Eliminar item de stock

<ApiPlayground
  method="DELETE"
  endpoint="/v1/stock/items/{id}"
  params={{ id: 'uuid-del-item' }}
  description="Elimina un item de stock"
/>

---

## üìä Operaciones de Stock

### Ajustar cantidad

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items/{id}/adjust"
  params={{ id: 'uuid-del-item' }}
  body={{
    sku: 'PROD-001',
    location_id: 'uuid-de-ubicacion',
    delta: 50,
    reason: 'Recepci√≥n de mercanc√≠a'
  }}
  description="Ajusta la cantidad de stock (positivo o negativo)"
/>

### Reservar stock

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items/{id}/reserve"
  params={{ id: 'uuid-del-item' }}
  body={{ quantity: 10 }}
  description="Reserva una cantidad de stock para una orden"
/>

### Liberar reserva

<ApiPlayground
  method="POST"
  endpoint="/v1/stock/items/{id}/release"
  params={{ id: 'uuid-del-item' }}
  body={{ quantity: 5 }}
  description="Libera stock previamente reservado"
/>

---

## üîÑ Cambio de Adaptador

El m√≥dulo soporta cambio din√°mico de repositorio via header HTTP:

```bash
# Usar Eloquent (default - base de datos)
curl http://localhost/api/v1/stock/items

# Usar InMemory (datos locales para testing)
curl http://localhost/api/v1/stock/items \
  -H "X-STOCK-ADAPTER: local"
```

### Adaptadores disponibles

| Header Value | Repositorio | Uso |
|--------------|-------------|-----|
| `eloquent` (default) | `StockItemRepository` | Producci√≥n (MySQL/PostgreSQL) |
| `local` | `InMemoryStockItemRepository` | Testing, desarrollo, demos |

---

## üìê Modelo de Datos

### StockItem

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | Identificador √∫nico |
| `sku` | string | C√≥digo SKU del producto |
| `catalog_item_id` | UUID | Referencia al item en cat√°logo |
| `catalog_origin` | string | Origen del cat√°logo (`internal_catalog`, etc.) |
| `location_id` | UUID | Ubicaci√≥n del stock |
| `location_type` | string | Tipo de ubicaci√≥n (`warehouse`, `store`, etc.) |
| `quantity` | int | Cantidad total |
| `reserved_quantity` | int | Cantidad reservada |
| `lot_number` | string? | N√∫mero de lote (opcional) |
| `expiration_date` | date? | Fecha de expiraci√≥n (opcional) |
| `serial_number` | string? | N√∫mero de serie (opcional) |
| `workspace_id` | UUID? | Workspace (multi-tenant) |
| `meta` | json? | Metadatos adicionales |

### Campos calculados

- `available_quantity` = `quantity` - `reserved_quantity`
- `is_expired` = `expiration_date < now()`
- `is_lot_tracked` = `lot_number !== null`
- `is_serial_tracked` = `serial_number !== null`

---

## ‚öôÔ∏è Location Stock Settings

Configuraci√≥n de capacidad y restricciones por ubicaci√≥n. Permite validar movimientos de stock contra l√≠mites definidos.

### Modelo de datos

| Campo | Tipo | Descripci√≥n |
|-------|------|-------------|
| `id` | UUID | Identificador √∫nico |
| `location_id` | UUID | Ubicaci√≥n asociada |
| `max_quantity` | int? | Capacidad m√°xima de unidades |
| `max_weight` | float? | Peso m√°ximo (kg) |
| `max_volume` | float? | Volumen m√°ximo (m¬≥) |
| `allowed_item_types` | array? | Tipos de items permitidos |
| `allow_mixed_lots` | bool | Permite mezclar lotes (default: true) |
| `allow_mixed_skus` | bool | Permite mezclar SKUs (default: true) |
| `fifo_enforced` | bool | Requiere FIFO (default: false) |
| `is_active` | bool | Estado activo |

### Validaciones de capacidad

El servicio `StockCapacityService` valida:

1. **Cantidad m√°xima**: Considera ubicaci√≥n + todos sus descendientes (jerarqu√≠a)
2. **Tipos de items**: Solo permite tipos en `allowed_item_types`
3. **Mezcla de SKUs**: Rechaza diferentes SKUs si `allow_mixed_skus = false`
4. **Mezcla de lotes**: Rechaza diferentes lotes si `allow_mixed_lots = false`

```php
// Ejemplo de uso
$result = $capacityService->canAcceptStock(
    locationId: 'warehouse-1',
    quantity: 100,
    sku: 'PROD-001',
    itemType: 'regular'
);

if ($result->isInvalid()) {
    // $result->getErrorCode() -> 'EXCEEDS_MAX_QUANTITY', 'MIXED_SKUS_NOT_ALLOWED', etc
    // $result->getContext() -> detalles del error
}
```

### Estad√≠sticas de capacidad

```php
$stats = $capacityService->getCapacityStats('warehouse-1');
// [
//   'current_quantity' => 75,
//   'max_quantity' => 100,
//   'available_quantity' => 25,
//   'usage_percent' => 75.0,
//   'unique_skus' => 3,
//   ...
// ]
```

---

## üß™ Testing

### Tests unitarios

```bash
# Ejecutar tests del m√≥dulo Stock
cd modules/catalog
./vendor/bin/phpunit --testsuite Stock --testdox
```

### Estructura de tests

```
app/Stock/Tests/
‚îú‚îÄ StockTestCase.php           # Base class con helpers
‚îú‚îÄ Domain/
‚îÇ  ‚îî‚îÄ StockItemTest.php        # Tests de entidad
‚îú‚îÄ Application/
‚îÇ  ‚îî‚îÄ StockItemUseCasesTest.php # Tests de UseCases con mocks
‚îî‚îÄ Infrastructure/
   ‚îî‚îÄ InMemoryStockItemRepositoryTest.php # Tests de repositorio
```

---

## üîó Integraci√≥n con Cat√°logo

El m√≥dulo usa `CatalogGatewayInterface` para integrarse con el cat√°logo de productos:

```php
interface CatalogGatewayInterface
{
    public function getItemData(string $catalogItemId, string $origin): ?array;
    public function linkToCatalog(StockItem $stockItem): void;
    public function attachCatalogData(array $stockItems): array;
    public function getDefaultOriginName(): string;
}
```

La implementaci√≥n por defecto (`PortalCatalogGateway`) usa el paquete `Thaumware\Portal` para conectar con el cat√°logo interno.

---

## üìù Ejemplos con curl

### Crear item de stock

```bash
curl -X POST http://localhost:8000/api/v1/stock/items \
  -H "Content-Type: application/json" \
  -d '{
    "sku": "LAPTOP-001",
    "catalog_item_id": "550e8400-e29b-41d4-a716-446655440000",
    "location_id": "660e8400-e29b-41d4-a716-446655440001",
    "quantity": 50
  }'
```

### Reservar stock

```bash
curl -X POST http://localhost:8000/api/v1/stock/items/abc123/reserve \
  -H "Content-Type: application/json" \
  -d '{"quantity": 5}'
```

### Usar adaptador InMemory

```bash
curl http://localhost:8000/api/v1/stock/items \
  -H "X-STOCK-ADAPTER: local"
```
