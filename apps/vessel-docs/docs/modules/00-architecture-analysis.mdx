---
sidebar_position: 1
---

# AnÃ¡lisis ArquitectÃ³nico del MÃ³dulo Catalog

## ğŸ“Š VisiÃ³n General

El mÃ³dulo **Catalog** estÃ¡ bien planteado como **meta-mÃ³dulo** que agrupa subdominios relacionados. Aunque necesita refactorizaciÃ³n en generalizacion y flexibilidad, la base hexagonal es sÃ³lida.

### MÃ³dulos Actuales

```
Catalog (meta-mÃ³dulo)
â”œâ”€â”€ Catalog/              # CatÃ¡logo de items (productos, servicios, etc.)
â”œâ”€â”€ Stock/                # GestiÃ³n de inventario
â”œâ”€â”€ Taxonomy/             # CategorizaciÃ³n y taxonomÃ­as
â”œâ”€â”€ Locations/            # Ubicaciones (almacenes, tiendas, etc.)
â”œâ”€â”€ Uom/                  # Unidades de medida
â”œâ”€â”€ Pricing/              # Precios y tarifas
â””â”€â”€ Auth/ (admin)         # Dashboard administrativo
```

---

## âœ… Fortalezas

### 1. **Arquitectura Hexagonal Consistente**
- âœ… Domain/Application/Infrastructure separados
- âœ… Interfaces de dominio (contracts) bien definidas
- âœ… Repositorios intercambiables (InMemory/Eloquent)
- âœ… Services de dominio encapsulados

**Ejemplo - Stock:**
```
Domain/ (lÃ³gica pura)
â”œâ”€â”€ Interfaces/ (CatalogGatewayInterface, LocationGatewayInterface)
â”œâ”€â”€ Services/ (StockCapacityService, StockMovementService)
â””â”€â”€ ValueObjects/ (MovementType, MovementStatus)

Application/ (casos de uso)
â””â”€â”€ UseCases/ (CreateStockItem, AdjustQuantity, ManageLocationSettings)

Infrastructure/ (adaptadores)
â”œâ”€â”€ In/Http/ (Controllers, Routes)
â””â”€â”€ Out/
    â”œâ”€â”€ Models/ (Eloquent)
    â”œâ”€â”€ InMemory/ (Testing)
    â””â”€â”€ Gateways/ (PortalCatalogGateway, LocationsModuleGateway)
```

### 2. **AbstracciÃ³n de ComunicaciÃ³n Inter-mÃ³dulos**

**Gateways** como patrÃ³n de integraciÃ³n:

| Gateway | PropÃ³sito | ImplementaciÃ³n |
|---------|-----------|---|
| `CatalogGatewayInterface` | Stock â†” Catalog | `PortalCatalogGateway` (Portal package) |
| `LocationGatewayInterface` | Stock â†” Locations | `LocationsModuleGateway` |

Esto permite que Stock **no dependa directamente** de Catalog/Locations, sino a travÃ©s de interfaces.

### 3. **Flexibilidad en Adaptadores**

**AdapterMiddleware** permite cambiar implementaciones en runtime:

```php
// Ejecutar con adapter diferente
curl http://localhost:8000/api/v1/stock/items \
  -H "X-STOCK-ADAPTER: local"  # InMemory en vez de Eloquent
```

Cada mÃ³dulo registra sus adaptadores:
```php
$this->app->instance('adapters.stock', [
    'interfaces' => [
        StockItemRepositoryInterface::class => [
            'local' => InMemoryStockItemRepository::class,
            'eloquent' => EloquentStockItemRepository::class,
        ],
    ],
]);
```

### 4. **Multi-Tenant Ready**

- `workspace_id` en todas las entidades principales
- Preparado para SaaS con datos aislados por workspace

---

## âš ï¸ Debilidades y Oportunidades

### 1. **Acoplamiento implÃ­cito a Modelos EspecÃ­ficos**

**Problema:** Cada mÃ³dulo define entidades muy especÃ­ficas:

```php
// Stock sÃ³lo entiende de StockItem, Movement, Lot
// Catalog sÃ³lo entiende de Item
// Â¿QuÃ© pasa con Suscripciones, Servicios, Activos?
```

**Oportunidad:** Generalizacion hacia **Entidades de Dominio PolimÃ³rficas**

```php
// Mejor: Concept<T> genÃ©rico
interface EntityRepositoryInterface {
    public function save(DomainEntity $entity): void;
    public function findById(string $id): ?DomainEntity;
}
```

### 2. **Portales Limitados a Catalog**

**Estado actual:**
- Solo `PortalCatalogGateway` usa Portal
- LocationGateway hace queries directas al repositorio

**Problema:** Si Locations estÃ¡ en otro servicio, falla.

**Mejora necesaria:**
```php
// Generalizar todos los gateways a usar Portal
class PortalLocationGateway implements LocationGatewayInterface {
    public function getDescendantIds(string $locationId): array {
        return Portal::query('locations', ['parent_id' => $locationId])->get();
    }
}
```

### 3. **DTOs ImplÃ­citos, sin Event Sourcing**

**SituaciÃ³n actual:**
- Los eventos de negocio no se registran (eventos de dominio)
- Cambios en stock no son auditables a nivel de negocio
- DifÃ­cil de replicate en otros servicios

**Mejora:**
```php
// Agregar Domain Events
class StockAdjustedEvent extends DomainEvent {
    public function __construct(
        public string $stockId,
        public float $delta,
        public float $newQuantity,
    ) {}
}
```

### 4. **Falta de Validaciones Compartidas**

**Problema:**
- Cada mÃ³dulo define sus propias validaciones
- Sin validaciÃ³n en "punto de entrada" Ãºnica
- Reglas de negocio esparcidas

**Ejemplo de mejora:**
```php
// Pipeline de validaciones centralizado
$pipeline = new ValidationPipeline([
    new SkuExistsValidator(),
    new LocationCapacityValidator(),
    new ItemTypeAllowedValidator(),
]);
```

### 5. **Repositories Parcialmente Persistidos**

| MÃ³dulo | Repositorio | Tipo | Status |
|--------|------------|------|--------|
| Stock | MovementRepository | InMemory | âš ï¸ Pendiente Eloquent |
| Stock | LotRepository | InMemory | âš ï¸ Pendiente Eloquent |
| Catalog | ItemRepository | Eloquent | âœ… OK |
| Taxonomy | TermRepository | Eloquent | âœ… OK |

**Oportunidad:** Completar persistencia.

---

## ğŸ¯ Recomendaciones de RefactorizaciÃ³n

### **Nivel 1: Inmediato (Corto Plazo)**

#### 1.1 Implementar Eloquent para MovementRepository y LotRepository
```php
// app/Stock/Infrastructure/Out/Models/Eloquent/MovementRepository.php
class EloquentMovementRepository implements MovementRepositoryInterface {
    public function save(Movement $movement): void {
        // Persistir en tabla movements
    }
}
```

**Impacto:** Stock totalmente persistible, auditorÃ­a completa.

#### 1.2 Generalizar LocationGateway a usar Portal
```php
// app/Stock/Infrastructure/Out/Gateways/PortalLocationGateway.php
class PortalLocationGateway implements LocationGatewayInterface {
    public function __construct(private Portal $portal) {}
    
    public function getDescendantIds(string $locationId): array {
        return $this->portal->query('locations')
            ->where('parent_id', $locationId)
            ->get()
            ->map(fn($l) => $l->id)
            ->toArray();
    }
}
```

**Impacto:** Ubicaciones totalmente desacopladas, preparado para microservicios.

#### 1.3 Agregar Domain Events
```php
// app/Stock/Domain/Events/MovementRecordedEvent.php
class MovementRecordedEvent extends DomainEvent {
    public function __construct(
        public Movement $movement,
        public float $balanceAfter,
    ) {}
}
```

**Impacto:** AuditorÃ­a, event sourcing ready.

---

### **Nivel 2: Mediano Plazo**

#### 2.1 Crear AbstracciÃ³n GenÃ©rica para Entidades
```php
// app/Shared/Domain/Entities/DomainEntity.php
interface DomainEntity {
    public function getId(): string;
    public function toArray(): array;
    public function getWorkspaceId(): ?string;
}

// Todos los dominios implementan esto
class StockItem implements DomainEntity { ... }
class Item implements DomainEntity { ... }
class Location implements DomainEntity { ... }
```

**Beneficio:** Repositorio genÃ©rico posible.

#### 2.2 Pipeline de Validaciones
```php
// app/Shared/Domain/Pipeline/ValidationPipeline.php
class ValidationPipeline {
    public function __construct(private array $validators) {}
    
    public function validate(mixed $entity): ValidationResult {
        foreach ($this->validators as $validator) {
            $result = $validator->validate($entity);
            if ($result->fails()) {
                return $result;
            }
        }
        return ValidationResult::valid();
    }
}
```

**Uso en Stock:**
```php
$pipeline = new ValidationPipeline([
    new MovementTypeValidator(),
    new LocationCapacityValidator(),
    new ItemAvailabilityValidator(),
]);

$result = $pipeline->validate($movement);
```

#### 2.3 Query Builder Pattern para BÃºsquedas
```php
// Reemplazar find() con queryable
interface QueryableRepositoryInterface {
    public function query(): QueryBuilder;
}

// app/Shared/Domain/Query/QueryBuilder.php
class QueryBuilder {
    public function where(string $field, mixed $value): self { ... }
    public function orderBy(string $field, string $direction = 'asc'): self { ... }
    public function paginate(int $page, int $limit): PaginatedResult { ... }
}
```

**Beneficio:** BÃºsquedas flexibles sin mÃ©todos custom.

---

### **Nivel 3: Largo Plazo (Arquitectura)**

#### 3.1 Soporte CQRS Opcional
```php
// app/Shared/Application/Bus/CommandBus.php
interface CommandBus {
    public function execute(Command $command): mixed;
}

// app/Stock/Application/Commands/AdjustStockQuantityCommand.php
class AdjustStockQuantityCommand implements Command {
    public function __construct(
        public string $itemId,
        public float $delta,
        public ?string $reason = null,
    ) {}
}
```

**Beneficio:** Operaciones desacopladas, facilita event sourcing.

#### 3.2 Service Mesh Ready
```php
// app/Shared/Infrastructure/Portals/ServiceRegistry.php
class ServiceRegistry {
    public function register(string $service, string $url): void {
        // Registrar servicio en "red de servicios"
        Portal::registerService($service, $url);
    }
    
    public function discover(string $service): ServiceDescriptor {
        // Descobrir ubicaciÃ³n de servicio
    }
}
```

#### 3.3 Observabilidad Completa
```php
// app/Shared/Infrastructure/Logging/DomainEventLogger.php
class DomainEventLogger {
    public function logEvent(DomainEvent $event): void {
        // Logs estructurados para auditorÃ­a/compliance
        Log::info('domain.event', [
            'event_type' => $event::class,
            'timestamp' => now(),
            'data' => $event->toArray(),
        ]);
    }
}
```

---

## ğŸ“ PatrÃ³n Actual vs Propuesto

### ConexiÃ³n de MÃ³dulos - HOY
```
Stock â”€â”€(PortalCatalogGateway)â”€â”€â”
                                â”œâ”€â”€> Portal Package
                                â”‚
Stock â”€â”€(LocationsModuleGateway)â”€â”€â”˜
        (queries directas - acoplado)
```

### ConexiÃ³n de MÃ³dulos - PROPUESTO
```
Stock â”€â”€(PortalCatalogGateway)â”€â”€â”
                                â”œâ”€â”€> Portal Package
Stock â”€â”€(PortalLocationGateway)â”€â”˜
                                â”Œâ”€â”€> ServiceRegistry
                                â”‚    (Service Discovery)
                                â”‚
                                â”œâ”€â”€> DomainEventBus
                                â”‚    (Event Sourcing)
                                â”‚
                                â””â”€â”€> ValidationPipeline
                                     (Reglas compartidas)
```

---

## ğŸ”„ Matriz de Flexibilidad

| Aspecto | Actual | Score | RecomendaciÃ³n |
|--------|--------|-------|---|
| **Intercambiabilidad de adaptadores** | AdapterMiddleware bien | 8/10 | Agregar factory pattern |
| **Desacoplamiento inter-mÃ³dulos** | Parcial (Portal + gateway) | 6/10 | Generalizar todos a Portal |
| **Eventos de dominio** | No existe | 0/10 | Implementar DomainEvent |
| **BÃºsquedas flexibles** | find(id) solo | 4/10 | QueryBuilder pattern |
| **Validaciones compartidas** | Cada mÃ³dulo own | 3/10 | Pipeline de validaciones |
| **Persistencia completa** | ~70% | 7/10 | Completar Eloquent repos |
| **Multi-tenant** | workspace_id presente | 7/10 | Middleware de aislamiento |
| **Testing** | InMemory repos present | 8/10 | Mantener y expandir |

**Score Total: 5.9/10** - Buen inicio, necesita maduraciÃ³n

---

## ğŸ’¡ Roadmap Recomendado

```
Q1 2025:
â”œâ”€â”€ Implementar EloquentMovementRepository
â”œâ”€â”€ Implementar EloquentLotRepository
â””â”€â”€ Agregar Domain Events (MovementRecorded, CapacityExceeded, etc.)

Q2 2025:
â”œâ”€â”€ Refactor LocationGateway â†’ PortalLocationGateway
â”œâ”€â”€ Implementar ValidationPipeline
â””â”€â”€ Agregar QueryBuilder para bÃºsquedas

Q3 2025:
â”œâ”€â”€ Implementar CommandBus (CQRS preparaciÃ³n)
â”œâ”€â”€ Event Sourcing para Stock movements
â””â”€â”€ Service Registry/Discovery

Q4 2025:
â”œâ”€â”€ Full CQRS en Stock module
â”œâ”€â”€ Observability (logs, metrics, tracing)
â””â”€â”€ DocumentaciÃ³n de patrones
```

---

## ğŸ“ ConclusiÃ³n

**El mÃ³dulo Catalog estÃ¡ bien estructurado pero necesita generalizacion.** 

**Fortalezas a mantener:**
- âœ… Arquitectura hexagonal
- âœ… SeparaciÃ³n clara de concerns
- âœ… Adaptadores intercambiables
- âœ… Portal para inter-module communication

**Cambios crÃ­ticos:**
- âš ï¸ Completar persistencia (MovementRepository, LotRepository)
- âš ï¸ Generalizar gateways a usar Portal uniformemente
- âš ï¸ Agregar Domain Events para auditorÃ­a
- âš ï¸ Extraer patrones reutilizables a Shared

**Beneficio despuÃ©s de refactorizaciÃ³n:** Sistema flexible, escalable, con clara separaciÃ³n entre servicios, listo para microservicios y event sourcing.
