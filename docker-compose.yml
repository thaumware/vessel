version: '3.9'

services:
  # Traefik - Reverse Proxy & Router
  traefik:
    image: traefik:v3.0
    container_name: vessel_traefik
    command:
      - "--api.insecure=true"
      - "--api.dashboard=true"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
    ports:
      - "80:80"      # HTTP
      - "8080:8080"  # Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - vessel_network
    restart: unless-stopped

  # Catalog Service (Laravel API)
  catalog:
    build:
      context: ./modules/catalog
      dockerfile: Dockerfile.dev
    container_name: vessel_catalog
    environment:
      APP_NAME: "Catalog Service"
      APP_ENV: local
      APP_DEBUG: "true"
      DB_CONNECTION: mysql
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_CATALOG_DATABASE:-catalog_db}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
    volumes:
      - ./modules/catalog:/app
      - ./modules/catalog/storage:/app/storage
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.catalog.rule=Host(`catalog.vessel.dev`)"
      - "traefik.http.routers.catalog.entrypoints=web"
      - "traefik.http.services.catalog.loadbalancer.server.port=8000"
    networks:
      - vessel_network
    depends_on:
      - traefik
    command: php artisan serve --host=0.0.0.0 --port=8000
    restart: unless-stopped

  # Inventory Service (Laravel API)
  inventory:
    build:
      context: ./modules/inventory
      dockerfile: Dockerfile.dev
    container_name: vessel_inventory
    environment:
      APP_NAME: "Inventory Service"
      APP_ENV: local
      APP_DEBUG: "true"
      DB_CONNECTION: mysql
      DB_HOST: ${DB_HOST:-127.0.0.1}
      DB_PORT: ${DB_PORT:-3306}
      DB_DATABASE: ${DB_INVENTORY_DATABASE:-inventory_db}
      DB_USERNAME: ${DB_USERNAME:-root}
      DB_PASSWORD: ${DB_PASSWORD:-root}
    volumes:
      - ./modules/inventory:/app
      - ./modules/inventory/storage:/app/storage
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.inventory.rule=Host(`inventory.vessel.dev`)"
      - "traefik.http.routers.inventory.entrypoints=web"
      - "traefik.http.services.inventory.loadbalancer.server.port=8000"
    networks:
      - vessel_network
    depends_on:
      - traefik
    command: php artisan serve --host=0.0.0.0 --port=8000
    restart: unless-stopped

networks:
  vessel_network:
    driver: bridge
